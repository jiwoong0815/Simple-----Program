# 거래명세서 자동 작성 툴 (v2 - JSON 마스터 연동)

이 프로그램은 GUI(Tkinter)를 통해 거래명세서를 Excel 파일(.xlsx)로 쉽게 생성할 수 있도록 돕는 도구입니다.
외부 JSON 파일에서 제품 마스터 데이터를 로드하고, 거래처별 가격 정책을 적용하여 명세서를 작성합니다.

## 주요 기능

- **제품 마스터 연동**:
    - 외부 JSON 파일 (기본: `이카운트_데이터_20240105.json`)에서 제품(품목) 정보를 로드합니다.
    - JSON 파일 내 여러 시트의 데이터를 통합하여 사용합니다.
    - 메뉴를 통해 제품 마스터 JSON 파일 경로를 변경하거나 데이터를 새로고침할 수 있습니다.
- **거래처 관리**:
    - 회사 정보를 추가, 수정, 삭제할 수 있습니다.
    - 각 거래처별로 적용될 가격 등급(매입단가, A단가, B단가, 일반대리점가, 치료재료단가)을 설정할 수 있습니다.
- **제품 마스터 조회**:
    - 로드된 전체 제품 마스터 목록을 조회하고 검색할 수 있습니다.
    - 각 품목의 상세 정보(LOT, 모델명, 규격, UDI-DI 등) 및 모든 가격 등급별 단가를 확인할 수 있습니다.
- **거래명세서 작성**:
    - 거래처를 선택하면 해당 거래처의 가격 등급이 자동으로 적용됩니다.
    - 제품 마스터에서 품목을 검색하고 선택하여 명세서에 추가합니다.
    - 품목 추가 시 수량을 입력하며, 선택된 거래처의 가격 등급에 맞는 단가가 자동으로 적용됩니다.
    - 명세서 품목 테이블에는 LOT, 모델명, 제품명, 규격, 납품수량, 단가, 공급가액, 부가세, 보험수가, 치료재료코드, UDI-DI가 표시됩니다.
    - 실시간으로 공급가액 합계, 부가세 합계, 총계를 확인할 수 있습니다.
    - 명세서의 특정 품목을 더블클릭하여 수량을 수정하거나 삭제할 수 있습니다.
- **Excel 출력**:
    - 작성된 명세서를 지정된 레이아웃의 Excel 파일로 생성합니다. (`YYYYMMDD_{회사명}_invoice.xlsx`)
    - `openpyxl` 라이브러리를 사용합니다.
    - 생성 후, 파일이 저장된 폴더를 파일 탐색기에서 열 수 있습니다.
- **데이터 영속성**:
    - 거래처 정보는 `data.json` 파일에 저장되어 프로그램 종료 후에도 유지됩니다.
    - 제품 마스터 정보는 외부 JSON 파일에서 읽어오며, 프로그램 내에서 직접 수정되지 않습니다.

## 사용 방법

1.  **프로그램 실행**:
    *   Python 3.11 환경이 필요합니다.
    *   필수 라이브러리: `openpyxl`. (`pip install openpyxl`)
    *   `main.py` 파일을 실행합니다: `python main.py`

2.  **최초 실행 및 제품 마스터 설정**:
    *   프로그램 실행 시 기본적으로 현재 작업 디렉토리 또는 사용자 다운로드 폴더에서 `이카운트_데이터_20240105.json` 파일을 찾으려고 시도합니다.
    *   파일을 찾지 못하거나 다른 파일을 사용하고 싶다면, 상단 메뉴의 **파일 > 제품 마스터 파일 선택...**을 클릭하여 올바른 JSON 파일을 지정합니다.
    *   JSON 파일 변경 후에는 **파일 > 제품 마스터 새로고침**을 통해 데이터를 다시 로드할 수 있습니다.

3.  **거래처 관리 탭**:
    *   **목록**: 등록된 거래처들이 표시됩니다. 선택 시 오른쪽에 세부 정보가 나타납니다.
    *   **정보 입력**: `회사명`, `연락처`, `가격 등급`을 입력/선택합니다.
    *   **가격 등급**: 드롭다운 메뉴에서 해당 거래처에 적용할 가격 정책(매입단가, A단가, B단가, 일반대리점가, 치료재료단가)을 선택합니다.
    *   **버튼**: `새로 입력`, `추가`, `수정`, `삭제` 기능을 제공합니다.

4.  **제품 마스터 조회 탭**:
    *   **검색**: 상단 검색창에 LOT, 모델명, 제품명, 규격 등으로 검색어를 입력하여 필터링할 수 있습니다.
    *   **목록 (Treeview)**: 로드된 제품 마스터의 상세 정보(LOT, 모델명, 제품명, 규격, 치료재료코드, UDI-DI 및 모든 가격 등급별 단가)가 표시됩니다.
    *   컬럼 헤더를 클릭하여 정렬할 수 있습니다. (읽기 전용)

5.  **거래명세서 작성 탭**:
    *   **거래처 선택**: 드롭다운 메뉴에서 명세서를 발행할 거래처를 선택합니다. 선택된 거래처의 가격 등급이 이후 품목 단가 결정에 사용됩니다.
    *   **담당자 (선택)**: 필요한 경우 담당자 이름을 입력합니다. (Excel 출력 시 미반영 - 필요시 기능 추가)
    *   **명세서 날짜**: 명세서 발행일입니다. 기본적으로 오늘 날짜가 설정되며, 수정 가능합니다. (형식: YYYY-MM-DD)
    *   **품목 검색**: 추가할 품목을 검색합니다 (LOT, 모델명, 제품명, 규격 기준). 검색 결과가 아래 리스트박스에 표시됩니다.
    *   **품목 리스트**: 검색된 품목 또는 전체 품목이 표시됩니다. 각 품목 옆에는 현재 선택된 거래처의 가격 등급에 따른 단가가 표시됩니다.
    *   **수량**: 리스트에서 품목 선택 후, 수량을 입력합니다.
    *   **품목 추가**: "품목 추가" 버튼을 클릭하여 명세서 테이블에 추가합니다. 동일 품목(LOT 기준)이 이미 있다면 수량 합치기 옵션이 제공됩니다.
    *   **거래명세서 품목 테이블 (Treeview)**:
        *   추가된 품목들의 상세 정보가 표시됩니다: `LOT, 모델명, 제품명, 규격, 납품수량, 단가, 공급가액, 부가세, 보험수가, 치료재료코드, UDI-DI`.
        *   테이블의 행을 더블클릭하여 해당 품목의 수량을 수정하거나 품목 자체를 삭제할 수 있습니다.
        *   컬럼 헤더를 클릭하여 정렬할 수 있습니다.
    *   **합계 정보**: 테이블 하단에 실시간으로 계산된 `공급가액 합계`, `부가세 합계`, `총계`가 표시됩니다.
    *   **버튼**: `선택 품목 삭제` (테이블에서 선택된 행 삭제), `명세서 초기화`, `엑셀 생성`.

6.  **데이터 저장**:
    *   거래처 정보는 추가/수정/삭제 시 `data.json` 파일에 즉시 저장됩니다.
    *   프로그램 종료 시에도 변경사항이 저장됩니다.
    *   제품 마스터 데이터는 외부 JSON 파일을 읽기 전용으로 사용하므로, 프로그램 내에서 저장되지 않습니다. 원본 JSON 파일을 직접 수정 후 "제품 마스터 새로고침" 기능을 사용해야 합니다.

## 파일 구조

```
project_root/
│  main.py              # GUI 실행 및 전체 애플리케이션 로직
│  models.py            # 데이터 클래스 정의 (Company, Item, InvoiceLine, PriceTier)
│  storage.py           # 데이터 로드/저장 로직 (회사 정보, 제품 마스터 JSON 파싱)
│  invoice.py           # Excel 생성 로직
│  data.json            # (자동 생성/관리) 거래처 데이터 저장 파일
│  이카운트_데이터_20240105.json # (샘플) 제품 마스터 데이터 파일 (경로 설정 가능)
└─ README.md            # 본 사용 설명서
```

## 주의사항
- 제품 마스터 JSON 파일의 형식은 제공된 `이카운트_데이터_20240105.json`의 구조를 따라야 합니다. (최상위 딕셔너리: 시트명 키, 값은 품목 객체 리스트)
- 필수 컬럼(`LOT, 모델명, 제품명, 규격, 치료재료코드, UDI-DI(필수입력)`)이 누락된 품목은 로드되지 않을 수 있습니다.
- 가격 필드(단가 계열)의 값이 숫자 형식이 아니면 해당 가격은 무시될 수 있습니다.
- 회사명은 중복될 수 없습니다.
